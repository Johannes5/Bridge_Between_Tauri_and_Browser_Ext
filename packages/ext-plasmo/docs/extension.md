# Bridge Extension Guide

The MV3 service worker in `packages/ext-plasmo/src/background.ts` keeps the desktop app and browser in sync. This page covers responsibilities, required permissions, and debugging tips.

## Responsibilities

- **Native messaging bridge**: Maintain a `chrome.runtime.connectNative("com.bridge.app")` port, validating envelopes with the shared proto schemas before forwarding them to the sidecar.
- **Tab inventory**: Subscribe to `chrome.tabs.*` and `chrome.windows.*`, normalize every tab via `serializeTab`, and push `tabs.list` payloads whenever the browser changes or the app asks for a refresh.
- **Connection identity**: Track the `connectionId` generated by the sidecar and attach it to every outbound payload. IDs change whenever the native host restarts; the desktop app now falls back to another connection or the first browser when a requested ID is missing.
- **`tabs.openOrFocus`**: Resolve the best tab candidate using URL heuristics (`exact`, `origin`, `path`), focus the window, wait ~50 ms, activate the tab, and focus the window again. If no match is found, create the tab and focus its window.
- **`tabs.restore`**: Rehydrate saved tab collections in either suspend or eager mode, respecting `preferWindowId` hints and reusing the same selection logic as single tab opens.
- **`focus.window`**: After activating or creating a tab, send a `focus.window` payload (windowId, title, url, browser, connectionId) so the sidecar can attempt to raise the window via Win32 APIs.

## Permissions and Manifest

`plasmo.manifest.ts` requests the following capabilities:

| Permission | Reason |
| --- | --- |
| `tabs`, `sessions`, `windows` | Read tab/window state, activate tabs, restore sessions |
| `scripting` | Inject helpers during suspended restores |
| `nativeMessaging` | Talk to the sidecar (`com.bridge.app`) |
| `host_permissions` (`http://*/*`, `https://*/*`) | Access titles and URLs for matching |

All logic runs in the service worker specified at `background.service_worker = "background.ts"`.

## Logging and Debugging

- Open `chrome://extensions`, find **Bridge Dev Extension**, click **Service Worker**, then **Inspect** to view `[bridge-ext]` logs.
- Enable **Preserve log** while testing focus flows; the worker restarts when the port reconnects.
- Use `chrome.runtime.sendMessage({ type: "test.openOrFocus", payload })` from the DevTools console to simulate app actions.
- Typical reconnection timeline:

  ```text
  [bridge-ext] connectNative failed: Error: Specified native messaging host not found.
  [bridge-ext] Connection established: Chrome (19a174a1afc-b312)
  [bridge-ext] Native port disconnected, scheduling reconnect
  ```

## Reconnection Behaviour

1. When `nativePort` disconnects (for example, after rebuilding the sidecar) the worker clears its handles and schedules `connectNative` with a short backoff.
2. As soon as the port is live, the worker publishes a fresh `tabs.list`, and the sidecar emits `presence.status` with the new `connectionId`.
3. The desktop app logs `[tabs.openOrFocus] Available connections: [...]` and stores snapshots keyed by the current IDs, falling back to the first active connection when routing fails.

## Interaction with the Sidecar

- Outgoing envelopes (`tabs.openOrFocus`, `tabs.restore`, `focus.window`, `presence.status`) are validated with the shared schemas to catch malformed data early.
- `focus.window` includes both numeric hints (`windowId`) and human-friendly details (`title`, `url`). The sidecar caches these to find the right HWND.
- Errors while calling Chrome APIs or while writing to the native port are logged with `console.warn("[bridge-ext] ...")` and, when possible, sent back to the desktop app as `type: "error"` envelopes.

## Related Documentation

- Architecture overview: [../../../docs/architecture.md](../../../docs/architecture.md)
- Native host internals: [`../sidecar/docs/native-host.md`](../sidecar/docs/native-host.md)
- Focus troubleshooting timeline: [../../../docs/troubleshooting/window-focus.md](../../../docs/troubleshooting/window-focus.md)
